AWSTemplateFormatVersion: 2010-09-09

Parameters:
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: m5.xlarge
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: "AWS::EC2::KeyPair::KeyName"
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  S3BucketName:
    Type: String
  EnvironmentName:
    Type: String
    Default: regulated-env
  SecurityGroupId:
    Type: String
    ConstraintDescription: must be the name of an existing Subnet.
  SubnetId:
    Type: String
    ConstraintDescription: must be the name of an existing Subnet.
  KmsKeyId:
    Type: String
    ConstraintDescription: must be the name of an existing Kms Key.

Mappings:
  AWSRegion2AMI:
    us-east-1:
      AMZN2: ami-06da18386448e0bb2
    us-east-2:
      AMZN2: ami-02fc03e64effbb81e
    us-west-1:
      AMZN2: ami-05b104638b311617c
    us-west-2:
      AMZN2: ami-03c1981b7c4e68106
    ap-south-1:
      AMZN2: ami-0e64613c7e8923f34
    ap-northeast-1:
      AMZN2: ami-037ed484873368428
    ap-northeast-2:
      AMZN2: ami-0151939c44c38e358
    ap-northeast-3:
      AMZN2: ami-09d0f3b739979cc39
    ap-southeast-1:
      AMZN2: ami-03b22b190af15e383
    ap-southeast-2:
      AMZN2: ami-0e966e6b570d093ca
    ca-central-1:
      AMZN2: ami-0e9ae085c3c134a90
    eu-central-1:
      AMZN2: ami-07f4cacde0048d491
    eu-west-1:
      AMZN2: ami-088b96e9fa1e46f67
    eu-west-2:
      AMZN2: ami-0c3f1ffa1af0a902c
    eu-west-3:
      AMZN2: ami-0d6d95e8568867039
    eu-north-1:
      AMZN2: ami-05e1cabe10125b07e
    sa-east-1:
      AMZN2: ami-06fba42dcfdf3443d

Resources:
  EC2Instance:
    Type: "AWS::EC2::Instance"
    Properties:
      Tags:
        - Key: Name
          Value: !Ref EnvironmentName

      InstanceType: !Ref InstanceType
      SecurityGroupIds:
        - !Ref SecurityGroupId
      SubnetId: !Ref SubnetId
      KeyName: !Ref KeyName
      ImageId: !FindInMap
        - AWSRegion2AMI
        - !Ref "AWS::Region"
        - AMZN2
      IamInstanceProfile: !Ref InstanceProfile
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 100
            VolumeType: gp3
            Iops: 600
            DeleteOnTermination: true
            Encrypted: true
            KmsKeyId: !Ref KmsKeyId

  InstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: /
      Roles:
        - !Ref InstanceRole

  InstanceRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - !Ref S3PolicyIL
        # Use managed policy
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AWSCodeCommitFullAccess

  S3PolicyIL:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Path: "/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowRWAccessToBucket
            Effect: Allow
            Action:
              - "s3:GetObject*"
              - "s3:PutObject*"
            Resource:
              - !Sub "arn:aws:s3:::${S3BucketName}/*"
              - arn:aws:s3:::patch-baseline-snapshot-region/*
              - arn:aws:s3:::aws-ssm-region/*
          - Sid: AllowListBucket
            Effect: Allow
            Action:
              - "s3:ListBucket"
            Resource:
              - !Sub "arn:aws:s3:::${S3BucketName}"
          - Sid: AllowKMS
            Effect: Allow
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
              - "kms:GenerateDataKeyWithoutPlaintext"
              - "kms:ReEncrypt*"
              - "kms:CreateGrant"
            Resource: "*"
Outputs:
  InstanceId:
    Description: InstanceId of the newly created EC2 instance
    Value: !Ref EC2Instance
